generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Company {
  id             String                 @id @default(uuid())
  name           String
  domain         String                 @unique
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  clients        Client[]
  settings       CompanySettings?
  fixedItems     FixedPriceItem[]
  interactions   Interaction[]
  invoices       Invoice[]
  meetings       Meeting[]
  payments       Payment[]
  knowledge      PricingKnowledge[]
  projects       Project[]
  scopes         ScopeOfWork[]
  logs           SubmissionLog[]
  users          User[]
  workBreakdowns WorkBreakdownPricing[]
}

model User {
  id                     String   @id
  email                  String   @unique
  name                   String?
  role                   Role     @default(MANAGER)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  companyId              String
  hasCompletedOnboarding Boolean  @default(false)
  company                Company  @relation(fields: [companyId], references: [id])
}

model CompanySettings {
  id                String   @id @default(uuid())
  name              String   @default("My Company")
  address           String?
  phone             String?
  email             String?
  website           String?
  logoUrl           String?
  taxId             String?
  bankDetails       String?
  paymentTerms      String?
  currency          String   @default("R")
  theme             String   @default("dark")
  layoutPreferences Json?
  updatedAt         DateTime @updatedAt
  aiEnabled         Boolean  @default(true)
  companyId         String   @unique
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model Client {
  id                 String          @id @default(uuid())
  name               String
  companyName        String?
  attentionTo        String?
  email              String?
  phone              String?
  address            String?
  vatNumber          String?
  registrationNumber String?
  vendorNumber       String?
  notes              String?
  tags               String[]        @default([])
  customFields       Json?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  companyId          String
  company            Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  interactions       Interaction[]
  invoices           Invoice[]
  meetings           Meeting[]
  projects           Project[]
  submissionLogs     SubmissionLog[]
}

model Project {
  id               String           @id @default(uuid())
  name             String
  description      String?
  status           ProjectStatus    @default(PLANNING)
  workflowStage    WorkflowStage    @default(SOW)
  commercialStatus CommercialStatus @default(AWAITING_PO)
  startDate        DateTime?
  endDate          DateTime?
  clientId         String
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  companyId        String
  invoices         Invoice[]
  meetings         Meeting[]
  client           Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  company          Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  scopes           ScopeOfWork[]
  submissionLogs   SubmissionLog[]
  workBreakdowns   WorkBreakdownPricing[]
}

model ScopeOfWork {
  id        String      @id @default(uuid())
  projectId String
  status    String      @default("DRAFT")
  version   Int         @default(1)
  site      String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  companyId String
  items     ScopeItem[]
  company   Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model ScopeItem {
  id          String      @id @default(uuid())
  scopeId     String
  area        String?
  description String
  quantity    Float       @default(1)
  unit        String?
  notes       String?
  scope       ScopeOfWork @relation(fields: [scopeId], references: [id], onDelete: Cascade)
}

model WorkBreakdownPricing {
  id          String                     @id @default(uuid())
  projectId   String
  status      String                     @default("DRAFT")
  version     Int                        @default(1)
  notes       String?
  site        String?
  quoteNumber String?
  createdAt   DateTime                   @default(now())
  updatedAt   DateTime                   @updatedAt
  companyId   String
  invoices    Invoice[]
  company     Company                    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project     Project                    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  items       WorkBreakdownPricingItem[]
}

model WorkBreakdownPricingItem {
  id          String               @id @default(uuid())
  wbpId       String
  area        String?
  description String
  quantity    Float                @default(1)
  unit        String?
  unitPrice   Float                @default(0)
  total       Float                @default(0)
  notes       String?
  wbp         WorkBreakdownPricing @relation(fields: [wbpId], references: [id], onDelete: Cascade)
}

model Interaction {
  id        String          @id @default(uuid())
  type      InteractionType @default(NOTE)
  content   String
  date      DateTime        @default(now())
  read      Boolean         @default(false)
  clientId  String
  createdAt DateTime        @default(now())
  companyId String
  client    Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  company   Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model Meeting {
  id        String   @id @default(uuid())
  title     String
  date      DateTime
  duration  Int      @default(60)
  location  String?
  notes     String?
  clientId  String?
  projectId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  companyId String
  client    Client?  @relation(fields: [clientId], references: [id])
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project   Project? @relation(fields: [projectId], references: [id])
}

model Invoice {
  id             String                @id @default(uuid())
  number         Int                   @default(autoincrement())
  type           InvoiceType           @default(QUOTE)
  status         InvoiceStatus         @default(DRAFT)
  date           DateTime              @default(now())
  dueDate        DateTime?
  clientId       String
  projectId      String?
  wbpId          String?
  subtotal       Float                 @default(0)
  taxRate        Float                 @default(0.15)
  taxAmount      Float                 @default(0)
  total          Float                 @default(0)
  notes          String?
  site           String?
  quoteNumber    String?
  reference      String?
  clientPoNumber String?
  paymentNotes   String?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  companyId      String
  client         Client                @relation(fields: [clientId], references: [id])
  company        Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project        Project?              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  wbp            WorkBreakdownPricing? @relation(fields: [wbpId], references: [id])
  items          InvoiceItem[]
  payments       Payment[]
}

model InvoiceItem {
  id          String  @id @default(uuid())
  invoiceId   String
  area        String?
  description String
  quantity    Float   @default(1)
  unit        String?
  unitPrice   Float   @default(0)
  total       Float   @default(0)
  notes       String?
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model Payment {
  id        String   @id @default(uuid())
  invoiceId String
  amount    Float
  date      DateTime @default(now())
  method    String?
  reference String?
  notes     String?
  createdAt DateTime @default(now())
  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invoice   Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model PricingKnowledge {
  id           String   @id @default(uuid())
  description  String
  typicalPrice Float
  minPrice     Float
  maxPrice     Float
  frequency    Int      @default(1)
  source       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  companyId    String
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model FixedPriceItem {
  id          String   @id @default(uuid())
  companyId   String
  description String
  unitPrice   Float
  unit        String?
  category    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model SubmissionLog {
  id          String         @id @default(uuid())
  type        SubmissionType
  documentId  String
  documentRef String?
  projectId   String?
  clientId    String?
  submittedBy String
  message     String
  metadata    Json?
  createdAt   DateTime       @default(now())
  companyId   String
  client      Client?        @relation(fields: [clientId], references: [id])
  company     Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project     Project?       @relation(fields: [projectId], references: [id])
}

enum Role {
  ADMIN
  MANAGER
}

enum InvoiceStatus {
  DRAFT
  PENDING_SCOPE
  SENT
  ACCEPTED
  REJECTED
  INVOICED
  PAID
  PARTIAL
  CANCELLED
}

enum InvoiceType {
  QUOTE
  INVOICE
}

enum ProjectStatus {
  SOW
  SOW_SUBMITTED
  LEAD
  QUOTED
  PLANNING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  INVOICED
  PAID
  ON_HOLD
  CANCELLED
}

enum InteractionType {
  CALL
  EMAIL
  MEETING
  NOTE
}

enum SubmissionType {
  SOW
  QUOTATION
  INVOICE
  WBP
}

enum WorkflowStage {
  SOW
  QUOTATION
  INVOICE
  PAYMENT
  COMPLETED
}

enum CommercialStatus {
  AWAITING_PO
  PO_RECEIVED
  EMERGENCY_WORK
}
